on:
  pull_request:

name: Test

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Check if all images tags are met
        run: |
          perl -nle 'm<FROM google/cloud-sdk:([0-9.]+)> and $seen{$1}++; END { die "tags differ: " . join " vs ", keys %seen if keys %seen != 1 }' $(find . -name Dockerfile | tee /dev/stderr)

      - name: Check if all variants correspond to their directories
        run: |
          set -e
          for f in $(find . -name Dockerfile); do v=$(basename $(dirname $f)); v=${v#.}; head -1 "$f" | grep -e "[0-9]${v:+-$v}\$"; done

      - run: |
          docker build .

      - run: |
          docker build ./alpine
